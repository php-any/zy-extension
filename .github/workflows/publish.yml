name: Publish VS Code Extension

on:
  push:
    tags:
      - "v*" # 当推送以 v 开头的 tag 时触发，例如 v1.0.4
  workflow_dispatch: # 允许手动触发
    inputs:
      version:
        description: "Version to publish (patch/minor/major)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  publish:
    name: Publish to VS Code Marketplace
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要写入权限来创建 release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 需要完整的 git 历史记录来生成版本号

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Checkout origami repository
        uses: actions/checkout@v4
        with:
          repository: php-any/origami
          path: origami
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: origami/tools/lsp/go.sum

      - name: Build LSP server
        working-directory: origami/tools/lsp
        run: |
          go mod download
          go build -o zy-lsp .
          ls -lh zy-lsp

      - name: Create bin directory and copy LSP binary
        run: |
          mkdir -p bin
          cp origami/tools/lsp/zy-lsp bin/
          chmod +x bin/zy-lsp
          ls -lh bin/

      - name: Compile TypeScript
        run: npm run compile

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手动触发时，使用输入的版本类型
            VERSION_TYPE="${{ github.event.inputs.version }}"
            echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          else
            # Tag 触发时，从 tag 名称提取版本
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}  # 移除 v 前缀
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Update version in package.json (if workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION_TYPE="${{ steps.version.outputs.version_type }}"
          npm version $VERSION_TYPE --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        id: update_version

      - name: Get final version
        id: final_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ steps.update_version.outputs.new_version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json version from tag (if needed)
        if: github.event_name == 'push'
        run: |
          TAG_VERSION="${{ steps.version.outputs.version }}"
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match package.json version ($PACKAGE_VERSION)"
            echo "Updating package.json version to match tag..."
            
            # 更新 package.json 中的版本号
            npm version $TAG_VERSION --no-git-tag-version
            
            echo "Updated package.json version to $TAG_VERSION"
          else
            echo "Version matches: $TAG_VERSION"
          fi

      - name: Install @vscode/vsce for packaging
        run: npm install -g @vscode/vsce

      - name: Package VSIX
        run: |
          vsce package
          ls -lh *.vsix
          VSIX_FILE=$(ls *.vsix | head -1)
          echo "vsix_file=$VSIX_FILE" >> $GITHUB_OUTPUT
        id: package

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          if [ -z "$VSCE_PAT" ]; then
            echo "Error: VSCE_PAT secret is not set"
            exit 1
          fi

          # 验证 PAT 格式
          if [ ${#VSCE_PAT} -lt 20 ]; then
            echo "Error: VSCE_PAT appears to be invalid (too short)"
            exit 1
          fi

          # 直接使用 --pat 参数发布，不需要先登录
          # 这种方式更可靠，避免了登录步骤可能的问题
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手动触发时，使用版本类型
            VERSION_TYPE="${{ github.event.inputs.version }}"
            vsce publish $VERSION_TYPE --pat "$VSCE_PAT"
          else
            # Tag 触发时，直接发布
            vsce publish --pat "$VSCE_PAT"
          fi

      - name: Create GitHub Release (if tag)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Release ${{ steps.final_version.outputs.version }}
          body: |
            ## Version ${{ steps.final_version.outputs.version }}

            See [CHANGELOG.md](CHANGELOG.md) for details.
          draft: false
          prerelease: false
          files: ${{ steps.package.outputs.vsix_file }}
          token: ${{ secrets.GITHUB_TOKEN }}
